# 核心概念与权限说明

## 一、存储层次

### 1. 本地存储（LocalStorage）
**位置**：浏览器本地（每个设备独立）
**作用**：
- 存储验证码账户数据
- 存储项目配置
- 存储全局 Token

**特点**：
- ✅ 无需联网即可使用
- ✅ 完全离线可用
- ❌ 仅当前浏览器可见
- ❌ 清空浏览器数据会丢失
- ❌ 无法跨设备访问

**操作**：
- 添加账户 → 本地存储
- 删除账户 → 本地存储
- 查看验证码 → 本地读取

---

### 2. 云端存储（Cloudflare KV）
**位置**：Cloudflare 边缘服务器
**作用**：
- 存储加密后的同步数据
- 存储分享的加密数据

**特点**：
- ✅ 可跨设备访问
- ✅ 端到端加密（服务器无法解密）
- ✅ 持久化存储
- ❌ 需要网络连接
- ❌ 需要配置项目

**操作**：
- 推送到云端 → 本地加密 → 上传到 KV
- 从云端拉取 → 下载密文 → 本地解密

---

## 二、项目管理

### 无项目状态
**场景**：首次使用，未创建任何同步项目
**可用功能**：
- ✅ 添加/删除验证码账户（本地）
- ✅ 查看验证码
- ✅ 导入/导出数据（本地文件）
- ✅ 设置主密码（本地加密）
- ❌ 无法推送到云端
- ❌ 无法从云端拉取
- ❌ 无法跨设备同步

**提示**：数据仅保存在当前浏览器中，清空浏览器数据会丢失。

---

### 有项目状态
**场景**：创建了至少一个同步项目
**可用功能**：
- ✅ 所有本地功能
- ✅ 推送到云端（加密上传）
- ✅ 从云端拉取（下载解密）
- ✅ 跨设备同步
- ✅ 多项目隔离管理
- ✅ 查看所有项目汇总（📊 全部项目视图 - **仅显示本地已有项目的数据**）

**项目配置**：
- **项目名称**：本地标识，方便区分（如"个人"、"工作"）
- **Sync ID**：云端唯一标识，用于区分不同用户/项目的数据
- **Sync Secret**：加密密钥，跨设备必须相同才能解密
- **自动同步**：可选，启用后自动推送/拉取

**重要说明**：
- 📊 **全部项目（汇总视图）** 只显示**你本地已创建项目的数据汇总**
- ❌ **不会显示云端其他用户的数据**
- ❌ **不会自动拉取所有云端项目**
- ✅ 只有你主动创建项目并配置相同的 Sync ID + Secret 才能访问对应的云端数据

---

## 三、Server Token 权限

### 后端未设置 SYNC_TOKEN
**服务端配置**：未设置环境变量 `SYNC_TOKEN`
**权限**：
- ✅ 任何人都可以推送（写入云端）
- ✅ 任何人都可以拉取（读取云端）
- ✅ 任何人都可以分享
- ✅ 任何人都可以撤销分享

**安全性**：
- ⚠️ 无权限保护
- ⚠️ 任何知道 Sync ID 的人都可以覆盖你的数据
- ⚠️ 适用于个人私有部署

**客户端操作**：
- 无需填写 Server Token
- 三击标题设置的 Token 留空即可

---

### 后端设置了 SYNC_TOKEN
**服务端配置**：设置了环境变量 `SYNC_TOKEN=your_secret_token`
**权限**：
- ✅ 读取云端：无需 Token（任何人可读）
- ❌ 写入云端：需要 Token（推送、分享、撤销）

**安全性**：
- ✅ 写入受保护，只有持有正确 Token 的人可以推送
- ✅ 防止他人覆盖你的云端数据
- ❌ 读取未保护（如需保护读取，用强密码的 Sync Secret）

**客户端操作**：
- 三击标题设置 Server Token（与后端 SYNC_TOKEN 一致）
- 推送时自动携带 Token
- Token 以密码形式存储，不明文显示

---

### 无 Token 时尝试推送到受保护的云端
**现象**：
- 推送失败，返回 401 错误
- Toast 提示："推送失败"

**解决方法**：
1. 三击页面标题"Web 2FA Authenticator"
2. 输入后端配置的 SYNC_TOKEN
3. 保存后重新推送

---

## 四、典型使用场景

### 场景 1：仅本地使用（最简单）
1. 打开网页
2. 添加验证码账户
3. 查看验证码
4. **无需**创建项目
5. **无需**设置 Token
6. **无需**联网

**适用**：单设备使用，不需要跨设备同步

**隐私保护**：
- ✅ 数据完全本地，不上传任何信息
- ✅ 无法被他人访问

---

### 场景 2：多设备同步（无 Token 保护）
**前提**：后端未设置 SYNC_TOKEN

**安全说明**：
- ⚠️ 任何知道你的 Sync ID 的人都可以推送数据（可能覆盖你的数据）
- ✅ 但只有拥有正确 Sync Secret 的人才能解密数据
- 💡 建议：使用强随机的 Sync ID（如 `user_a8f3k9d2l5m7`）和 Sync Secret

#### 设备 A（首次）
1. 添加验证码账户
2. 点击"同步" → "新建项目"
3. 填写：
   - 项目名称：个人账号
   - Sync ID：my-personal-2fa
   - Sync Secret：MyStrongPassword123
4. 保存项目
5. 点击"推送到云端"

#### 设备 B（首次）
1. 点击"同步" → "新建项目"
2. 填写**相同**的配置：
   - Sync ID：my-personal-2fa
   - Sync Secret：MyStrongPassword123
3. 保存项目
4. 点击"从云端拉取"
5. 验证码自动同步

#### 日常使用
- 启用"自动同步"：每 60 秒自动拉取，保存后自动推送
- **无需**设置 Server Token

---

### 场景 3：多设备同步（有 Token 保护）
**前提**：后端设置了 `SYNC_TOKEN=secret123`

**安全说明**：
- ✅ 写入受保护：只有持有正确 Token 的人可以推送
- ✅ 防止他人覆盖你的云端数据
- ✅ 但读取仍然开放（任何人可以下载密文）
- 🔐 **核心保护**：Sync Secret 加密确保即使下载密文也无法解密

**隐私保护机制**：
```
攻击者尝试访问你的数据：
1. 猜测你的 Sync ID（如 my-2fa）→ ✅ 可能猜到
2. 下载云端密文 → ✅ 可以下载（拉取无需 Token）
3. 尝试解密密文 → ❌ 失败（没有你的 Sync Secret）
4. 尝试覆盖数据 → ❌ 失败（推送需要 Token）

结论：数据安全 ✅
```

#### 设备 A（首次）
1. 三击标题"Web 2FA Authenticator"
2. 输入 Server Token：secret123
3. 保存
4. 创建项目并推送（同场景 2）

#### 设备 B（首次）
1. 三击标题，输入相同的 Server Token：secret123
2. 创建项目（Sync ID 和 Secret 相同）
3. 从云端拉取

#### 无 Token 的人
- ✅ 可以拉取（读取云端数据）
- ❌ 无法推送（写入失败，返回 401）
- ❌ 无法覆盖你的数据

---

### 场景 4：管理多个账号集合
**需求**：个人账号、工作账号、测试账号分开管理

1. 创建项目 1：
   - 名称：个人账号
   - Sync ID：my-personal
   - Secret：password1

2. 创建项目 2：
   - 名称：工作账号
   - Sync ID：my-work
   - Secret：password2

3. 创建项目 3：
   - 名称：测试环境
   - Sync ID：my-test
   - Secret：password3

4. 切换项目：点击项目卡片即可切换

5. 查看所有：点击"📊 全部项目（汇总视图）"

**注意**：
- 每个项目独立推送/拉取
- 汇总视图仅显示本地已有项目的数据，不可删除（需切换到具体项目）

**安全说明**：
- 📊 **全部项目视图**是本地虚拟视图，不是云端数据
- ✅ 只显示你本地已创建和配置的项目
- ❌ 不会自动发现或拉取云端其他项目
- ❌ 不会显示其他用户的数据
- 💡 即使你知道别人的 Sync ID，也需要手动创建项目并配置才能访问

---

## 五、数据流向图

```
┌─────────────────────────────────────────────────────────────────┐
│                          完整数据流                               │
└─────────────────────────────────────────────────────────────────┘

添加账户
   ↓
本地存储（LocalStorage）
   │
   │  [创建项目] ← 配置 Sync ID + Secret
   ↓
推送到云端
   │
   ├─ 本地加密（使用 Sync Secret）
   │
   ├─ [有 Token] → 携带 X-Token 请求头
   │
   ├─ [无 Token] → 直接发送
   │
   ↓
Cloudflare KV（密文）
   │
   ↓
其他设备拉取
   │
   ├─ 下载密文
   │
   ├─ 本地解密（使用相同的 Sync Secret）
   │
   ↓
本地存储（LocalStorage）
   │
   ↓
显示验证码
```

---

## 六、常见问题

### Q: 我需要设置 Server Token 吗？
**A**：取决于你的后端配置：
- 后端未设置 `SYNC_TOKEN` → 无需设置
- 后端设置了 `SYNC_TOKEN` → 需要设置（否则无法推送）
- 不确定 → 先尝试推送，失败则设置

### Q: 忘记 Server Token 怎么办？
**A**：
- Server Token 仅用于写入权限，不影响数据安全
- 联系后端管理员获取 `SYNC_TOKEN`
- 或修改后端环境变量

### Q: 忘记 Sync Secret 怎么办？
**A**：
- Sync Secret 是加密密钥，忘记无法恢复云端数据
- 只能重新推送（会覆盖云端旧数据）

### Q: 不创建项目可以用吗？
**A**：
- ✅ 可以！所有本地功能都可用
- ❌ 无法推送/拉取（无云端同步）

### Q: 主密码和 Sync Secret 有什么区别？
**A**：
- **主密码**：本地数据加密，保护浏览器存储
- **Sync Secret**：云端数据加密，端到端保护
- 两者独立，互不影响

### Q: 为什么汇总视图不能删除？
**A**：
- 汇总视图是只读的，防止误删
- 需要删除账户时，切换到具体项目再操作

### Q: "全部项目视图"会显示云端所有用户的数据吗？
**A**：
- ❌ **不会！** 这是最大的误解
- 📊 全部项目视图是**本地虚拟视图**，只显示你本地已创建项目的数据汇总
- ✅ 不会访问云端其他用户的数据
- ✅ 不会自动拉取云端所有项目
- 💡 工作原理：遍历你本地的 `state.syncProjects` 数组，合并所有项目的 `itemsData`

**示例说明**：
```
你的本地项目列表：
- 项目 A：个人账号（Sync ID: my-personal）
- 项目 B：工作账号（Sync ID: my-work）

云端存在的其他数据：
- alice-2fa（其他用户 Alice 的数据）
- bob-company（其他用户 Bob 的数据）

点击"全部项目视图"后：
✅ 显示：项目 A + 项目 B 的验证码
❌ 不显示：alice-2fa、bob-company

要访问 alice-2fa：
你需要手动创建新项目，填写 Sync ID=alice-2fa 和正确的 Secret
```

### Q: 那我怎么访问其他设备的数据？
**A**：
**正确流程**：
1. 在设备 A 创建项目（如 Sync ID: my-personal, Secret: password123）
2. 推送到云端
3. 在设备 B 创建**相同配置**的项目（Sync ID: my-personal, Secret: password123）
4. 从云端拉取

**关键点**：
- ✅ 你需要在两台设备上**主动创建项目**
- ✅ 配置必须**完全一致**（Sync ID 和 Secret）
- ❌ 不会自动发现你的其他设备

### Q: Sync ID 和 Sync Secret 可以修改吗？
**A**：
- 可以修改，但会导致：
  - 修改 Sync ID → 云端数据无法访问（不同的 ID）
  - 修改 Sync Secret → 云端数据无法解密（不同的密钥）
- 建议谨慎操作，或先导出备份

---

## 七、权限矩阵

| 操作 | 无项目 | 有项目 | 后端无 Token | 后端有 Token + 客户端无 Token | 后端有 Token + 客户端有 Token |
|------|--------|--------|--------------|-------------------------------|-------------------------------|
| 添加账户（本地） | ✅ | ✅ | ✅ | ✅ | ✅ |
| 查看验证码（本地） | ✅ | ✅ | ✅ | ✅ | ✅ |
| 删除账户（本地） | ✅ | ✅ | ✅ | ✅ | ✅ |
| 推送到云端 | ❌ | ✅ | ✅ | ❌ (401) | ✅ |
| 从云端拉取 | ❌ | ✅ | ✅ | ✅ | ✅ |
| 分享验证码 | ✅ | ✅ | ✅ | ❌ (401) | ✅ |
| 撤销分享 | ✅ | ✅ | ✅ | ❌ (401) | ✅ |

---

## 八、调试检查清单

遇到问题时，按顺序检查：

1. **数据在本地吗？**
   - 打开浏览器开发者工具 → Application → Local Storage
   - 查看 `authenticator.v1` 键

2. **项目配置正确吗？**
   - 点击"同步"查看项目列表
   - 确认 Sync ID 和 Secret 已填写

3. **网络连接正常吗？**
   - 打开开发者工具 → Network 标签
   - 尝试推送，查看请求状态

4. **Token 配置正确吗？**
   - 推送失败 401 → 需要设置 Server Token
   - 三击标题检查 Token 状态

5. **Sync Secret 一致吗？**
   - 拉取后解密失败 → Sync Secret 不一致
   - 确认所有设备使用相同的 Secret

6. **浏览器权限问题？**
   - 扫码失败 → 检查摄像头权限
   - 复制失败 → 检查剪贴板权限